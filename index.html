<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>YouTube Playlist Player</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Inter", Arial, sans-serif;
            background: linear-gradient(135deg, #0a0e0f 0%, #0d1b1e 100%);
            color: #e8f4f8;
            display: flex;
            height: 100vh;
            overflow: hidden;
        }

        .main-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            padding: 24px;
            overflow-y: auto;
            background: rgba(13, 27, 30, 0.6);
        }

        .video-container {
            position: relative;
            width: 100%;
            max-width: 1200px;
            margin: 0 auto 24px;
            padding-bottom: 56.25%;
            background: linear-gradient(145deg, #0d1b1e, #1a2b2e);
            border-radius: 16px;
            overflow: hidden;
            box-shadow: 0 8px 32px rgba(0, 217, 163, 0.15);
            border: 1px solid rgba(0, 217, 163, 0.1);
        }

        #player {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            border-radius: 16px;
        }

        .controls {
            max-width: 1200px;
            margin: 0 auto;
            width: 100%;
            background: linear-gradient(145deg, #1a2b2e, #0d1b1e);
            padding: 20px 24px;
            border-radius: 16px;
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
            justify-content: center;
            align-items: center;
            box-shadow: 0 4px 24px rgba(0, 0, 0, 0.4);
            border: 1px solid rgba(78, 204, 163, 0.2);
        }

        .controls button {
            background: linear-gradient(135deg, #00d9a3, #4ecca3);
            color: #0a0e0f;
            border: none;
            padding: 12px 28px;
            border-radius: 12px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 0 4px 12px rgba(0, 217, 163, 0.3);
        }

        .controls button:hover {
            background: linear-gradient(135deg, #4ecca3, #00d9a3);
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0, 217, 163, 0.4);
        }

        .controls button:active {
            transform: translateY(0);
            box-shadow: 0 2px 8px rgba(0, 217, 163, 0.3);
        }

        .controls button.active {
            background: linear-gradient(135deg, #ffa726, #ffb74d);
            box-shadow: 0 4px 12px rgba(255, 167, 38, 0.4);
        }

        .controls button.active:hover {
            background: linear-gradient(135deg, #ffb74d, #ffa726);
        }

        .controls button:disabled {
            background: linear-gradient(135deg, #2a3a3d, #1a2528);
            color: #5a6a6d;
            opacity: 0.5;
            cursor: not-allowed;
            box-shadow: none;
            transform: none;
        }

        /* Toggle Switch - Modernized */
        .toggle-container {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 8px 16px;
            background: rgba(0, 217, 163, 0.1);
            border-radius: 12px;
            border: 1px solid rgba(0, 217, 163, 0.2);
        }

        .toggle-switch {
            position: relative;
            width: 56px;
            height: 28px;
            background: linear-gradient(145deg, #2a3a3d, #1a2528);
            border-radius: 14px;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: inset 0 2px 8px rgba(0, 0, 0, 0.3);
        }

        .toggle-switch.active {
            background: linear-gradient(135deg, #00d9a3, #4ecca3);
            box-shadow: 0 2px 12px rgba(0, 217, 163, 0.4);
        }

        .toggle-slider {
            position: absolute;
            top: 3px;
            left: 3px;
            width: 22px;
            height: 22px;
            background: linear-gradient(145deg, #e8f4f8, #ffffff);
            border-radius: 50%;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.3);
        }

        .toggle-switch.active .toggle-slider {
            transform: translateX(28px);
            background: linear-gradient(145deg, #ffffff, #e8f4f8);
        }

        .toggle-label {
            font-size: 14px;
            font-weight: 600;
            color: #00d9a3;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .sidebar {
            width: 420px;
            background: linear-gradient(180deg, #0d1b1e 0%, #0a0e0f 100%);
            display: flex;
            flex-direction: column;
            border-left: 2px solid rgba(0, 217, 163, 0.2);
            box-shadow: -4px 0 24px rgba(0, 0, 0, 0.3);
        }

        .sidebar-header {
            padding: 24px;
            background: linear-gradient(145deg, #1a2b2e, #0d1b1e);
            border-bottom: 2px solid rgba(78, 204, 163, 0.2);
        }

        .sidebar-header h2 {
            font-size: 20px;
            margin-bottom: 20px;
            color: #00d9a3;
            font-weight: 700;
            letter-spacing: 0.5px;
            text-transform: uppercase;
        }

        .url-input-container {
            display: flex;
            gap: 10px;
            margin-bottom: 12px;
        }

        .url-input-container input {
            flex: 1;
            padding: 12px 16px;
            background: rgba(10, 14, 15, 0.8);
            border: 2px solid rgba(0, 217, 163, 0.3);
            border-radius: 12px;
            color: #e8f4f8;
            font-size: 14px;
            transition: all 0.3s ease;
        }

        .url-input-container input:focus {
            outline: none;
            border-color: #00d9a3;
            box-shadow: 0 0 0 3px rgba(0, 217, 163, 0.1);
            background: rgba(10, 14, 15, 1);
        }

        .url-input-container input::placeholder {
            color: #5a6a6d;
        }

        .url-input-container button {
            background: linear-gradient(135deg, #00d9a3, #4ecca3);
            color: #0a0e0f;
            border: none;
            padding: 12px 20px;
            border-radius: 12px;
            cursor: pointer;
            font-weight: 600;
            white-space: nowrap;
            transition: all 0.3s ease;
            box-shadow: 0 4px 12px rgba(0, 217, 163, 0.3);
        }

        .url-input-container button:hover {
            background: linear-gradient(135deg, #4ecca3, #00d9a3);
            transform: translateY(-2px);
            box-shadow: 0 6px 16px rgba(0, 217, 163, 0.4);
        }

        .url-input-container .paste-btn {
            background: linear-gradient(135deg, #ffb74d, #ffa726);
            box-shadow: 0 4px 12px rgba(255, 183, 77, 0.3);
        }

        .url-input-container .paste-btn:hover {
            background: linear-gradient(135deg, #ffa726, #ffb74d);
            box-shadow: 0 6px 16px rgba(255, 183, 77, 0.4);
        }

        .playlist-actions {
            display: flex;
            gap: 10px;
            margin-top: 12px;
        }

        .playlist-actions button {
            flex: 1;
            background: rgba(42, 58, 61, 0.6);
            color: #e8f4f8;
            border: 1px solid rgba(78, 204, 163, 0.2);
            padding: 10px;
            border-radius: 10px;
            cursor: pointer;
            font-size: 12px;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .playlist-actions button:hover {
            background: rgba(78, 204, 163, 0.2);
            border-color: #4ecca3;
            transform: translateY(-1px);
        }

        .playlist-container {
            flex: 1;
            overflow-y: auto;
            padding: 12px;
        }

        .playlist-item {
            background: linear-gradient(145deg, #1a2b2e, #0d1b1e);
            padding: 12px;
            margin-bottom: 10px;
            border-radius: 12px;
            display: flex;
            gap: 12px;
            cursor: move;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            border: 1px solid rgba(78, 204, 163, 0.1);
        }

        .playlist-item:hover {
            background: linear-gradient(145deg, #2a3b3e, #1a2b2e);
            border-color: rgba(78, 204, 163, 0.3);
            transform: translateX(4px);
            box-shadow: 0 4px 16px rgba(0, 217, 163, 0.2);
        }

        .playlist-item.active {
            background: linear-gradient(135deg, #00d9a3, #4ecca3);
            color: #0a0e0f;
            border-color: #4ecca3;
            box-shadow: 0 4px 20px rgba(0, 217, 163, 0.4);
        }

        .playlist-item.active .playlist-item-title,
        .playlist-item.active .drag-handle {
            color: #0a0e0f;
        }

        .playlist-item.dragging {
            opacity: 0.6;
            transform: scale(0.98);
        }

        .playlist-item img {
            width: 56px;
            height: 56px;
            object-fit: cover;
            border-radius: 8px;
            background: #0a0e0f;
            border: 1px solid rgba(78, 204, 163, 0.2);
        }

        .playlist-item-info {
            flex: 1;
            min-width: 0;
            display: flex;
            flex-direction: column;
            justify-content: center;
        }

        .playlist-item-title {
            font-size: 13px;
            font-weight: 600;
            margin-bottom: 4px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            color: #e8f4f8;
        }

        .playlist-item-actions {
            display: flex;
            gap: 6px;
            align-items: center;
        }

        .playlist-item-actions button {
            background: linear-gradient(135deg, #ff6b6b, #ff5252);
            color: #fff;
            border: none;
            padding: 6px 12px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 11px;
            font-weight: 600;
            transition: all 0.3s ease;
            box-shadow: 0 2px 8px rgba(255, 107, 107, 0.3);
        }

        .playlist-item-actions button:hover {
            background: linear-gradient(135deg, #ff5252, #ff6b6b);
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(255, 107, 107, 0.4);
        }

        .playlist-item-actions .play-btn {
            background: linear-gradient(135deg, #00d9a3, #4ecca3);
            color: #0a0e0f;
            box-shadow: 0 2px 8px rgba(0, 217, 163, 0.3);
        }

        .playlist-item-actions .play-btn:hover {
            background: linear-gradient(135deg, #4ecca3, #00d9a3);
            box-shadow: 0 4px 12px rgba(0, 217, 163, 0.4);
        }

        .playlist-item.active .playlist-item-actions button {
            background: linear-gradient(135deg, #0a0e0f, #0d1b1e);
            color: #e8f4f8;
        }

        .playlist-item.active .playlist-item-actions .play-btn {
            background: linear-gradient(135deg, #0d1b1e, #0a0e0f);
            color: #00d9a3;
        }

        .drag-handle {
            cursor: move;
            padding: 5px;
            color: #5a6a6d;
            font-size: 18px;
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #5a6a6d;
            font-size: 15px;
        }

        ::-webkit-scrollbar {
            width: 10px;
        }

        ::-webkit-scrollbar-track {
            background: rgba(10, 14, 15, 0.4);
            border-radius: 5px;
        }

        ::-webkit-scrollbar-thumb {
            background: linear-gradient(180deg, #00d9a3, #4ecca3);
            border-radius: 5px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: linear-gradient(180deg, #4ecca3, #00d9a3);
        }
    </style>
</head>
<body>
    <div class="main-content">
        <div class="video-container">
            <div id="player"></div>
        </div>
        <div class="controls">
            <div class="toggle-container">
                <span class="toggle-label">Autoplay</span>
                <div class="toggle-switch" id="autoplayToggle">
                    <div class="toggle-slider"></div>
                </div>
            </div>
            <button id="previousBtn">Previous</button>
            <button id="playPauseBtn" disabled>Play</button>
            <button id="nextBtn">Next</button>
            <button id="repeatBtn">Repeat: Off</button>
        </div>
    </div>

    <div class="sidebar">
        <div class="sidebar-header">
            <h2>Playlist</h2>
            <div class="url-input-container">
                <input type="text" id="urlInput" placeholder="Paste YouTube URL here..." maxlength="500">
                <button id="pasteBtn" class="paste-btn">Paste & Add</button>
                <button id="addBtn">Add</button>
            </div>
            <div class="playlist-actions">
                <button id="clearBtn">Clear All</button>
                <button id="downloadBtn">Download</button>
                <button id="importBtn">Import</button>
            </div>
        </div>
        <div class="playlist-container" id="playlistContainer">
            <div class="empty-state">Add videos to start your playlist</div>
        </div>
    </div>

    <input type="file" id="importFile" accept=".txt" style="display: none;">

    <script src="https://www.youtube.com/iframe_api"></script>
    <script>
        'use strict';

        const state = {
            playlist: [],
            currentIndex: -1,
            repeatMode: 'off',
            autoplay: false,
            player: null,
            playerReady: false,
            isPlaying: false
        };

        const elements = {
            urlInput: document.getElementById('urlInput'),
            addBtn: document.getElementById('addBtn'),
            pasteBtn: document.getElementById('pasteBtn'),
            playlistContainer: document.getElementById('playlistContainer'),
            autoplayToggle: document.getElementById('autoplayToggle'),
            previousBtn: document.getElementById('previousBtn'),
            nextBtn: document.getElementById('nextBtn'),
            playPauseBtn: document.getElementById('playPauseBtn'),
            repeatBtn: document.getElementById('repeatBtn'),
            clearBtn: document.getElementById('clearBtn'),
            downloadBtn: document.getElementById('downloadBtn'),
            importBtn: document.getElementById('importBtn'),
            importFile: document.getElementById('importFile')
        };

        // Security: HTML entity encoding
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // Security: Validate playlist structure
        function isValidPlaylist(data) {
            if (!Array.isArray(data)) return false;
            if (data.length > 1000) return false; // Max 1000 items
            
            return data.every(item => {
                return item &&
                       typeof item.id === 'string' &&
                       typeof item.url === 'string' &&
                       typeof item.title === 'string' &&
                       item.id.length === 11 &&
                       item.url.length < 500 &&
                       item.title.length < 200;
            });
        }

        // YouTube IFrame API Ready
        function onYouTubeIframeAPIReady() {
            state.player = new YT.Player('player', {
                height: '100%',
                width: '100%',
                playerVars: {
                    'playsinline': 1,
                    'rel': 0,
                    'modestbranding': 1,
                    'origin': window.location.origin
                },
                events: {
                    'onReady': onPlayerReady,
                    'onStateChange': onPlayerStateChange,
                    'onError': onPlayerError
                }
            });
        }

        function onPlayerReady(event) {
            state.playerReady = true;
            console.log('Player ready');
        }

        function onPlayerStateChange(event) {
            if (event.data === YT.PlayerState.ENDED) {
                console.log('Video ended');
                if (state.autoplay) {
                    playNext();
                }
            } else if (event.data === YT.PlayerState.PLAYING) {
                state.isPlaying = true;
                elements.playPauseBtn.textContent = 'Pause';
                elements.playPauseBtn.disabled = false;
            } else if (event.data === YT.PlayerState.PAUSED) {
                state.isPlaying = false;
                elements.playPauseBtn.textContent = 'Play';
                elements.playPauseBtn.disabled = false;
            }
        }

        function onPlayerError(event) {
            console.error('Player error:', event.data);
            // Auto-skip on error if autoplay is on
            if (state.autoplay) {
                setTimeout(() => playNext(), 2000);
            }
        }

        function extractVideoId(url) {
            if (!url || typeof url !== 'string') return null;
            if (url.length > 500) return null; // Security: Limit URL length
            
            const patterns = [
                /(?:youtube\.com\/watch\?v=)([a-zA-Z0-9_-]{11})/,
                /(?:youtu\.be\/)([a-zA-Z0-9_-]{11})/,
                /(?:youtube\.com\/embed\/)([a-zA-Z0-9_-]{11})/,
                /(?:youtube\.com\/shorts\/)([a-zA-Z0-9_-]{11})/,
                /^([a-zA-Z0-9_-]{11})$/
            ];
            
            for (const pattern of patterns) {
                const match = url.match(pattern);
                if (match && match[1]) {
                    return match[1];
                }
            }
            return null;
        }

        async function fetchVideoInfo(videoId) {
            try {
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 5000); // 5s timeout
                
                const response = await fetch(
                    `https://www.youtube.com/oembed?url=https://www.youtube.com/watch?v=${videoId}&format=json`,
                    { signal: controller.signal }
                );
                
                clearTimeout(timeoutId);
                
                if (response.ok) {
                    const data = await response.json();
                    // Security: Sanitize title
                    const title = String(data.title || `Video ${videoId.substring(0, 8)}`).substring(0, 200);
                    return {
                        title: title,
                        thumbnail: `https://i.ytimg.com/vi/${videoId}/default.jpg`
                    };
                }
            } catch (error) {
                console.error('Error fetching video info:', error);
            }
            
            return {
                title: `Video ${videoId.substring(0, 8)}`,
                thumbnail: `https://i.ytimg.com/vi/${videoId}/default.jpg`
            };
        }

        function truncateTitle(title, maxLength = 30) {
            if (!title) return '';
            return title.length > maxLength ? title.substring(0, maxLength - 3) + '...' : title;
        }

        async function addVideo(url) {
            if (!url || typeof url !== 'string') {
                alert('Invalid input');
                return;
            }

            const videoId = extractVideoId(url.trim());
            if (!videoId) {
                alert('Invalid YouTube URL');
                return;
            }

            if (state.playlist.some(v => v.id === videoId)) {
                alert('Video already in playlist');
                return;
            }

            // Security: Limit playlist size
            if (state.playlist.length >= 1000) {
                alert('Playlist limit reached (1000 videos)');
                return;
            }

            const info = await fetchVideoInfo(videoId);
            const video = {
                id: videoId,
                url: `https://www.youtube.com/watch?v=${videoId}`, // Normalize URL
                title: truncateTitle(info.title),
                fullTitle: info.title,
                thumbnail: info.thumbnail
            };

            state.playlist.push(video);
            savePlaylist();
            renderPlaylist();
            elements.urlInput.value = '';
        }

        async function pasteAndAdd() {
            try {
                const text = await navigator.clipboard.readText();
                if (text && text.length < 500) {
                    elements.urlInput.value = text;
                    await addVideo(text);
                }
            } catch (error) {
                // Fallback: just focus the input
                elements.urlInput.focus();
                console.log('Clipboard access denied, please paste manually');
            }
        }

        function removeVideo(index) {
            if (typeof index !== 'number' || index < 0 || index >= state.playlist.length) return;
            
            if (state.currentIndex === index) {
                stopVideo();
            } else if (state.currentIndex > index) {
                state.currentIndex--;
            }
            state.playlist.splice(index, 1);
            savePlaylist();
            renderPlaylist();
        }

        function playVideo(index) {
            if (typeof index !== 'number' || index < 0 || index >= state.playlist.length) return;
            if (!state.playerReady) {
                console.error('Player not ready');
                return;
            }
            
            state.currentIndex = index;
            const video = state.playlist[index];
            
            try {
                state.player.loadVideoById(video.id);
                elements.playPauseBtn.disabled = false;
            } catch (error) {
                console.error('Error loading video:', error);
            }
            
            renderPlaylist();
        }

        function stopVideo() {
            if (state.player && state.playerReady) {
                try {
                    state.player.stopVideo();
                } catch (error) {
                    console.error('Error stopping video:', error);
                }
            }
            state.currentIndex = -1;
            state.isPlaying = false;
            elements.playPauseBtn.disabled = true;
            elements.playPauseBtn.textContent = 'Play';
            renderPlaylist();
        }

        function playNext() {
            if (state.playlist.length === 0) return;
            
            if (state.repeatMode === 'one' && state.currentIndex !== -1) {
                playVideo(state.currentIndex);
                return;
            }

            let nextIndex = state.currentIndex + 1;
            
            if (nextIndex >= state.playlist.length) {
                if (state.repeatMode === 'all') {
                    nextIndex = 0;
                } else {
                    stopVideo();
                    return;
                }
            }
            
            playVideo(nextIndex);
        }

        function playPrevious() {
            if (state.playlist.length === 0) return;
            
            let prevIndex = state.currentIndex - 1;
            
            if (prevIndex < 0) {
                if (state.repeatMode === 'all') {
                    prevIndex = state.playlist.length - 1;
                } else {
                    return;
                }
            }
            
            playVideo(prevIndex);
        }

        function togglePlayPause() {
            if (!state.player || !state.playerReady) return;
            
            try {
                if (state.isPlaying) {
                    state.player.pauseVideo();
                } else {
                    state.player.playVideo();
                }
            } catch (error) {
                console.error('Error toggling playback:', error);
            }
        }

        function toggleAutoplay() {
            state.autoplay = !state.autoplay;
            elements.autoplayToggle.classList.toggle('active', state.autoplay);
            
            if (state.autoplay && state.currentIndex === -1 && state.playlist.length > 0) {
                playVideo(0);
            }
        }

        function cycleRepeatMode() {
            const modes = ['off', 'all', 'one'];
            const currentIdx = modes.indexOf(state.repeatMode);
            state.repeatMode = modes[(currentIdx + 1) % modes.length];
            updateRepeatButton();
        }

        function updateRepeatButton() {
            const modeLabels = {
                'off': 'Repeat: Off',
                'all': 'Repeat: All',
                'one': 'Repeat: One'
            };
            elements.repeatBtn.textContent = modeLabels[state.repeatMode];
            elements.repeatBtn.classList.toggle('active', state.repeatMode !== 'off');
        }

        function renderPlaylist() {
            if (state.playlist.length === 0) {
                elements.playlistContainer.innerHTML = '<div class="empty-state">Add videos to start your playlist</div>';
                return;
            }

            // Security: Use escapeHtml for all user-generated content
            const html = state.playlist.map((video, index) => {
                const safeTitle = escapeHtml(video.title);
                const safeFullTitle = escapeHtml(video.fullTitle || video.title);
                const safeThumbnail = escapeHtml(video.thumbnail);
                
                return `
                    <div class="playlist-item ${index === state.currentIndex ? 'active' : ''}" 
                         draggable="true" 
                         data-index="${index}"
                         title="${safeFullTitle}">
                        <div class="drag-handle">⋮⋮</div>
                        <img src="${safeThumbnail || 'data:image/svg+xml,%3Csvg xmlns=%22http://www.w3.org/2000/svg%22 width=%2256%22 height=%2256%22%3E%3Crect fill=%22%230a0e0f%22 width=%2256%22 height=%2256%22/%3E%3C/svg%3E'}" 
                             alt="Thumbnail" 
                             onerror="this.src='data:image/svg+xml,%3Csvg xmlns=%22http://www.w3.org/2000/svg%22 width=%2256%22 height=%2256%22%3E%3Crect fill=%22%230a0e0f%22 width=%2256%22 height=%2256%22/%3E%3C/svg%3E'">
                        <div class="playlist-item-info">
                            <div class="playlist-item-title">${safeTitle}</div>
                        </div>
                        <div class="playlist-item-actions">
                            <button class="play-btn" data-action="play" data-index="${index}">Play</button>
                            <button data-action="remove" data-index="${index}">Remove</button>
                        </div>
                    </div>
                `;
            }).join('');

            elements.playlistContainer.innerHTML = html;
            attachDragListeners();
        }

        let draggedElement = null;
        let draggedIndex = null;

        function attachDragListeners() {
            const items = document.querySelectorAll('.playlist-item');
            
            items.forEach(item => {
                item.addEventListener('dragstart', handleDragStart);
                item.addEventListener('dragover', handleDragOver);
                item.addEventListener('drop', handleDrop);
                item.addEventListener('dragend', handleDragEnd);
            });
        }

        function handleDragStart(e) {
            draggedElement = this;
            draggedIndex = parseInt(this.dataset.index);
            this.classList.add('dragging');
            e.dataTransfer.effectAllowed = 'move';
            e.dataTransfer.setData('text/plain', draggedIndex); // Required for Firefox
        }

        function handleDragOver(e) {
            if (e.preventDefault) {
                e.preventDefault();
            }
            e.dataTransfer.dropEffect = 'move';
            return false;
        }

        function handleDrop(e) {
            if (e.stopPropagation) {
                e.stopPropagation();
            }
            e.preventDefault();
            
            const dropIndex = parseInt(this.dataset.index);
            
            if (draggedIndex !== null && draggedIndex !== dropIndex && 
                draggedIndex >= 0 && draggedIndex < state.playlist.length &&
                dropIndex >= 0 && dropIndex < state.playlist.length) {
                
                const draggedVideo = state.playlist[draggedIndex];
                state.playlist.splice(draggedIndex, 1);
                state.playlist.splice(dropIndex, 0, draggedVideo);
                
                if (state.currentIndex === draggedIndex) {
                    state.currentIndex = dropIndex;
                } else if (draggedIndex < state.currentIndex && dropIndex >= state.currentIndex) {
                    state.currentIndex--;
                } else if (draggedIndex > state.currentIndex && dropIndex <= state.currentIndex) {
                    state.currentIndex++;
                }
                
                savePlaylist();
                renderPlaylist();
            }
            
            return false;
        }

        function handleDragEnd(e) {
            this.classList.remove('dragging');
            draggedElement = null;
            draggedIndex = null;
        }

        function clearPlaylist() {
            if (state.playlist.length === 0) return;
            if (confirm('Clear all videos from playlist?')) {
                stopVideo();
                state.playlist = [];
                savePlaylist();
                renderPlaylist();
            }
        }

        function downloadPlaylist() {
            if (state.playlist.length === 0) {
                alert('Playlist is empty');
                return;
            }

            const urls = state.playlist.map(v => v.url).join('\n');
            const blob = new Blob([urls], { type: 'text/plain;charset=utf-8' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'youtube_playlist.txt';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        function importPlaylist() {
            elements.importFile.click();
        }

        elements.importFile.addEventListener('change', async (e) => {
            const file = e.target.files[0];
            if (!file) return;

            // Security: Limit file size to 1MB
            if (file.size > 1024 * 1024) {
                alert('File too large (max 1MB)');
                elements.importFile.value = '';
                return;
            }

            try {
                const text = await file.text();
                const urls = text.split('\n')
                    .map(line => line.trim())
                    .filter(line => line && !line.startsWith('#'))
                    .slice(0, 1000); // Max 1000 URLs
                
                let addedCount = 0;
                for (const url of urls) {
                    if (state.playlist.length >= 1000) break;
                    
                    const videoId = extractVideoId(url);
                    if (videoId && !state.playlist.some(v => v.id === videoId)) {
                        const info = await fetchVideoInfo(videoId);
                        state.playlist.push({
                            id: videoId,
                            url: `https://www.youtube.com/watch?v=${videoId}`,
                            title: truncateTitle(info.title),
                            fullTitle: info.title,
                            thumbnail: info.thumbnail
                        });
                        addedCount++;
                    }
                }

                if (addedCount > 0) {
                    savePlaylist();
                    renderPlaylist();
                }
            } catch (error) {
                alert('Error reading file');
                console.error('Import error:', error);
            }
            
            elements.importFile.value = '';
        });

        function savePlaylist() {
            try {
                localStorage.setItem('youtube_playlist', JSON.stringify(state.playlist));
            } catch (error) {
                console.error('Failed to save playlist:', error);
                if (error.name === 'QuotaExceededError') {
                    alert('Storage quota exceeded. Please remove some videos.');
                }
            }
        }

        function loadPlaylist() {
            try {
                const saved = localStorage.getItem('youtube_playlist');
                if (saved) {
                    const parsed = JSON.parse(saved);
                    // Security: Validate structure
                    if (isValidPlaylist(parsed)) {
                        state.playlist = parsed;
                        renderPlaylist();
                    } else {
                        console.warn('Invalid playlist data, ignoring');
                    }
                }
            } catch (error) {
                console.error('Failed to load playlist:', error);
            }
        }

        // Event Listeners - Use event delegation for better security
        elements.addBtn.addEventListener('click', () => addVideo(elements.urlInput.value));
        elements.pasteBtn.addEventListener('click', pasteAndAdd);
        elements.urlInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                e.preventDefault();
                addVideo(elements.urlInput.value);
            }
        });
        
        elements.autoplayToggle.addEventListener('click', toggleAutoplay);
        elements.previousBtn.addEventListener('click', playPrevious);
        elements.nextBtn.addEventListener('click', playNext);
        elements.playPauseBtn.addEventListener('click', togglePlayPause);
        elements.repeatBtn.addEventListener('click', cycleRepeatMode);
        elements.clearBtn.addEventListener('click', clearPlaylist);
        elements.downloadBtn.addEventListener('click', downloadPlaylist);
        elements.importBtn.addEventListener('click', importPlaylist);

        // Event delegation for playlist actions
        elements.playlistContainer.addEventListener('click', (e) => {
            const button = e.target.closest('button[data-action]');
            if (!button) return;
            
            const action = button.dataset.action;
            const index = parseInt(button.dataset.index);
            
            if (action === 'play') {
                playVideo(index);
            } else if (action === 'remove') {
                removeVideo(index);
            }
        });

        // Keyboard shortcuts
        document.addEventListener('keydown', (e) => {
            if (e.target.tagName === 'INPUT') return;
            
            if (e.code === 'Space') {
                e.preventDefault();
                togglePlayPause();
            }
        });

        // Initialize
        loadPlaylist();
    </script>
</body>
</html>
